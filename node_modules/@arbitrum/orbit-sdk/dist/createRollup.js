"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createRollup = void 0;
const contracts_1 = require("./contracts");
const ParentChain_1 = require("./types/ParentChain");
const createRollupDefaults_1 = require("./createRollupDefaults");
const createRollupGetCallValue_1 = require("./createRollupGetCallValue");
const createRollupGetMaxDataSize_1 = require("./createRollupGetMaxDataSize");
const createRollupPrepareTransactionReceipt_1 = require("./createRollupPrepareTransactionReceipt");
const isCustomFeeTokenAddress_1 = require("./utils/isCustomFeeTokenAddress");
const isAnyTrustChainConfig_1 = require("./utils/isAnyTrustChainConfig");
async function createRollup({ params, publicClient, walletClient, }) {
    const chainId = publicClient.chain?.id;
    const account = walletClient.account?.address;
    if (!(0, ParentChain_1.validParentChainId)(chainId)) {
        throw new Error('chainId is undefined');
    }
    if (typeof account === 'undefined') {
        throw new Error('account is undefined');
    }
    const chainConfig = JSON.parse(params.config.chainConfig);
    if ((0, isCustomFeeTokenAddress_1.isCustomFeeTokenAddress)(params.nativeToken) &&
        !(0, isAnyTrustChainConfig_1.isAnyTrustChainConfig)(chainConfig)) {
        throw new Error(`Custom fee token can only be used on AnyTrust chains. Set "arbitrum.DataAvailabilityCommittee" to "true" in the chain config.`);
    }
    const maxDataSize = (0, createRollupGetMaxDataSize_1.createRollupGetMaxDataSize)(chainId);
    const paramsWithDefaults = { ...createRollupDefaults_1.defaults, ...params, maxDataSize };
    const { request } = await publicClient.simulateContract({
        address: contracts_1.rollupCreator.address[chainId],
        abi: contracts_1.rollupCreator.abi,
        functionName: 'createRollup',
        args: [paramsWithDefaults],
        value: (0, createRollupGetCallValue_1.createRollupGetCallValue)(paramsWithDefaults),
        account,
    });
    const hash = await walletClient.writeContract(request);
    const txReceipt = await publicClient.waitForTransactionReceipt({ hash });
    return (0, createRollupPrepareTransactionReceipt_1.createRollupPrepareTransactionReceipt)(txReceipt);
}
exports.createRollup = createRollup;
